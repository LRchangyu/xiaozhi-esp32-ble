# 蓝牙WiFi配网 - 队列处理优化

## 改进概述

将BLE数据接收处理从事件回调中分离出来，使用队列和专门的处理线程来处理接收到的数据。这样可以避免在BLE事件回调中进行耗时操作，提高系统的响应性和稳定性。

## 架构改进

### 原始架构
```
BLE事件回调 → 直接处理数据 → 发送响应
     ↓
可能阻塞BLE事件系统
```

### 新架构
```
BLE事件回调 → 数据放入队列 → 快速返回
     ↓
专门的处理线程 → 从队列取数据 → 处理命令 → 发送响应
```

## 技术细节

### 1. 队列数据结构
```c
typedef struct {
    uint16_t conn_id;
    uint16_t handle;
    uint8_t data[256];  // 最大数据长度
    size_t data_len;
} ble_data_queue_item_t;
```

### 2. 新增变量
- `g_ble_data_queue`: FreeRTOS队列，用于存储待处理的BLE数据
- `g_ble_process_task`: 数据处理任务句柄
- `g_process_task_running`: 控制处理任务的运行状态

### 3. 数据处理流程

#### BLE事件接收
1. 接收到`BLE_EVT_DATA_RECEIVED`事件
2. 创建队列项并复制数据
3. 将队列项放入处理队列
4. 快速返回，不阻塞BLE事件系统

#### 数据处理线程
1. 从队列中取出数据项（100ms超时）
2. 解析协议数据包
3. 根据命令类型处理请求
4. 发送响应数据
5. 循环处理下一个数据项

## 性能优化

### 优势
1. **非阻塞处理**: BLE事件回调快速返回，不会阻塞蓝牙栈
2. **并发处理**: 数据接收和处理可以并行进行
3. **缓冲机制**: 队列提供数据缓冲，应对突发数据
4. **错误隔离**: 处理线程的错误不会影响BLE事件系统

### 配置参数
- **队列大小**: 10个数据项（可根据需要调整）
- **任务栈大小**: 4096字节
- **任务优先级**: 5
- **队列超时**: 100ms

## 使用方法

使用方法与之前完全相同，这是内部实现的优化：

```cpp
// 初始化（内部会创建队列和处理线程）
auto& ble_wifi_config = BleWifiConfig::GetInstance();
ble_wifi_config.Initialize();

// 正常使用
ble_wifi_config.StartAdvertising("device-name");

// 清理（内部会销毁队列和处理线程）
ble_wifi_config.Deinitialize();
```

## 资源管理

### 初始化时创建
- 创建队列（容量10个数据项）
- 启动数据处理任务
- 设置任务运行标志

### 清理时销毁
- 停止任务运行标志
- 等待任务自然结束（最多1秒）
- 删除队列
- 清理相关资源

## 错误处理

1. **队列满**: 如果队列满了，新数据会被丢弃并记录警告
2. **数据过大**: 超过256字节的数据会被拒绝
3. **任务创建失败**: 初始化时会清理已创建的资源
4. **优雅退出**: 清理时会等待任务正常结束

## 调试信息

处理过程中会输出详细的日志信息：
- 数据接收日志
- 队列操作状态
- 数据处理进度
- 错误和警告信息

## 注意事项

1. **数据大小限制**: 单个数据包最大256字节
2. **队列容量**: 可以根据实际需求调整队列大小
3. **任务优先级**: 确保处理任务有足够的CPU时间
4. **内存使用**: 队列会占用一定的内存空间

这个优化显著提高了系统的稳定性和响应能力，特别是在处理复杂命令（如WiFi扫描）时的表现。
