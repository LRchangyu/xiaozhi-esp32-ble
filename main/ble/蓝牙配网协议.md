# 说明

小智 AI 自定义的 BLE 协议。

目前支持 WiFi 配网和 OTA。

# BLE 定义

## 广播

广播名称必须带有 `"lr_wificfg-"` 前缀。

## 服务

|      | UUID                                                                  | 功能          |
| ---- | --------------------------------------------------------------------- | ------------- |
| 服务 | 16bit : `0xFDD0`  <br>128bit : `0000FDD0-0000-1000-8000-00805f9b34fb` |               |
| 特性 | 16bit : `0xFDD1`  <br>128bit : `0000FDD1-0000-1000-8000-00805f9b34fb` | write |
| 特性 | 16bit : `0xFDD2`  <br>128bit : `0000FDD1-0000-1000-8000-00805f9b34fb` | notify |

> 注意 APP 和小程序发现服务后，对 UUID 的处理和判断。

## 通信规则

- 每个指令超时为 10 秒。
- 连接间隔应小于等于 150 ms。

# 协议格式

| header  |  cmd | payload  |
| ------------ | ------------ | ------------ |
| 0x58 0x5A  | 0x00 - 0xff  |  n |

**ack**

| value | value                      |
| ----- | -------------------------- |
| 0     | 成功，可以开始发送文件数据 |
| 1    | 错误 |
| 2    | 升级版本不允许升级 |

## 获取当前 WiFi 配置：0x00

设备的 WiFi 配置： ssid = "chinanet"，password = "12345678"

### APP -> 设备

| header  |  cmd |  payload  |
| ------------ | ------------ | ------------ |
| 0x58 0x5A  | 0x00  |  --- |

### 设备 -> APP

| header  |  cmd |  payload |
| ------------ | ------------ | ------------ |
| 0x58 0x5A  | 0x00  |  8 (len of ssid) + chinanet + 8 (len of password) + password |

## 修改 WiFi 配置：0x01

修改设备的 WiFi 配置为： ssid = "chinanet"，password = "12345678"

### APP -> 设备

| header  |  cmd |  payload  |
| ------------ | ------------ | ------------ |
| 0x58 0x5A  | 0x01  |  8 (len of ssid) + chinanet + 8 (len of password) + password  |

### 设备 -> APP

| header    | cmd | payload                                   |
| --------- | --- | ----------------------------------------- |
| 0x58 0x5A | 0x01   | aack（1 byte ） |

## 获取 WiFi 扫描列表：0x02

### APP -> 设备

| header  |  cmd |  payload  |
| ------------ | ------------ | ------------ |
| 0x58 0x5A  | 0x02 |  --- |

### 设备 -> APP

| header    | cmd  | payload                              |
| --------- | ---- | ------------------------------------ |
| 0x58 0x5A | 0x02 | ap_nums + len of 1st + 1st ssid name .... |


> 扫描到的 ap 太多，可分可多次回复。
> 最后以 58 5A 02 00 结束。

## 发送文件信息：0x03

APP 发送文件信息：版本 + 文件大小 + 文件 CRC32

### APP -> 设备

| header  |  cmd |  payload  |
| ------------ | ------------ | ------------ |
| 0x58 0x5A  | 0x03 |  版本（3 bytes） + 文件大小 ( 4 bytes ) + 文件 CRC32 ( 4 bytes ) |

### 设备 -> APP

| header    | cmd  | payload                                                           |
| --------- | ---- | ----------------------------------------------------------------- |
| 0x58 0x5A | 0x04 | ack（1 byte）+ 数据包长度 packet_length（2 bytes, `取值范围：[64,4096]`） |



## 发送文件数据：0x04

APP 发送文件数据。

根据设备返回的数据包长度 packet_length ，连续发送 packet_length 字节。
> APP 自行分包，根据蓝牙特性，数据是按顺序到达的。

### APP -> 设备

| header  |  cmd |  payload  |
| ------------ | ------------ | ------------ |
| 0x58 0x5A  | 0x04 |  n bytes ，根据 MTU 和 packet_length，分包。 |

### 设备 -> APP


| header    | cmd  | payload                                                           |
| --------- | ---- | ----------------------------------------------------------------- |
| 0x58 0x5A | 0x04 | ack（1 bytes） |

接收的数据：

1、未达到 packet_length 字节 ，设备不回复。

2、数据达到 packet_length 字节，设备回复一次。

3、数据超过 packet_length 字节，设备停止升级，并回复错误。

## 发送数据包校验值：0x05

APP 发送完 packet_length 文件数据后。

发送一次 packet_length 的数据 CRC32 校验，做一次整体校验。

### APP -> 设备

| header  |  cmd |  payload  |
| ------------ | ------------ | ------------ |
| 0x58 0x5A  | 0x05 |  n bytes |

### 设备 -> APP

| header    | cmd  | payload                                                           |
| --------- | ---- | ----------------------------------------------------------------- |
| 0x58 0x5A | 0x05 | ack（1 bytes）+ crc32 (设备计算的crc32) |


> 命令：0x03、0x04、0x05，只要出现错误，APP 都要提示升级失败，请重试。